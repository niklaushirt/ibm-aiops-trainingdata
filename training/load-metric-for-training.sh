#!/bin/bash
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# LOAD LOGS DIRECTLY INTO ELASTICSEARCH
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ADAPT VALUES
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

echo " ------------------------------------------------------------------------------------------------------------------------------"
echo " üöÄ Starting Load (>=4.1)"
echo " ------------------------------------------------------------------------------------------------------------------------------"
echo "  "
echo "  "

export INDEX_TYPE=metrics


#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# DO NOT EDIT BELOW
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


if [[  $VERSION == "" ]]; then
    echo "   ------------------------------------------------------------------------------------------------------------------------------"
    echo "   üî¨ Setting Version to default latest"
    echo "   ------------------------------------------------------------------------------------------------------------------------------"
    export VERSION=latest
fi





if [[  $WAIOPS_NAMESPACE == "" ]]; then
    # Get Namespace from Cluster 
    echo "   ------------------------------------------------------------------------------------------------------------------------------"
    echo "   üî¨ Getting Installation Namespace"
    echo "   ------------------------------------------------------------------------------------------------------------------------------"
    export WAIOPS_NAMESPACE=$(oc get po -A|grep aimanager-operator |awk '{print$1}')
    echo "       ‚úÖ OK - AI Manager:               $WAIOPS_NAMESPACE"
fi

if [ ! -x "$(command -v unzip)" ]; then
      echo "‚ùå Unzip not installed."

      echo "‚ùå Aborting...."
      exit 1
fi


echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üîé  Get Cassandra Authentication"	
echo "   ------------------------------------------------------------------------------------------------------------------------------"
export CASSANDRA_PASS=$(oc get secret aiops-topology-cassandra-auth-secret -n $WAIOPS_NAMESPACE -o jsonpath='{.data.password}' | base64 -d)
export CASSANDRA_USER=$(oc get secret aiops-topology-cassandra-auth-secret -n $WAIOPS_NAMESPACE -o jsonpath='{.data.username}' | base64 -d)

echo "CASSANDRA_USER:$CASSANDRA_USER"
echo "CASSANDRA_PASS:$CASSANDRA_PASS"


echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üîé  Check for Training Files in ./training-data/$VERSION/$INDEX_TYPE/"	
echo "   ------------------------------------------------------------------------------------------------------------------------------"
export MERIC_FILES=$(ls -1 ./training-data/$VERSION/$INDEX_TYPE/ | grep "dt_metric_value")	
if [[ $MERIC_FILES == "" ]] ;	
then	
      echo "           ‚ùó No Metric Dump files found"	
      echo "           ‚ùó    No Metric Dump files found to ingest in path ./training-data/$VERSION/$INDEX_TYPE/"	
      echo "           ‚ùó    Please place them in the directory."	
      echo "           ‚ùå Aborting..."	
      exit 1	
else	
      echo "     ‚úÖ Dump Files:                 OK"	
fi	
echo "     "	


#--------------------------------------------------------------------------------------------------------------------------------------------	
#  Check Credentials	
#--------------------------------------------------------------------------------------------------------------------------------------------	

echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üóÑÔ∏è  Indexes to be loaded from ./training-data/$VERSION/$INDEX_TYPE/"	
echo "   ------------------------------------------------------------------------------------------------------------------------------"
ls -1 ./training-data/$VERSION/$INDEX_TYPE/ | grep "dt_metric_value"	 | sed 's/^/          /'
echo "       "	
echo "       "	



echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üíæ Copy Files into Pod"
echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "      üëâ Version    : $VERSION"
echo "  "
echo "  "
    oc rsync -n $WAIOPS_NAMESPACE ./training-data/$VERSION/$INDEX_TYPE/ aiops-topology-cassandra-0:/tmp/
echo "  "
echo "  "


echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üßª Empty Cassandra tables"
echo "   ------------------------------------------------------------------------------------------------------------------------------"
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"TRUNCATE  tararam.dt_metric_value;\""
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"TRUNCATE  tararam.md_metric_resource;\""
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"TRUNCATE  tararam.md_resource;\""
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"TRUNCATE  tararam.md_group;\""
echo "  "
echo "  "

echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üîé Check Cassandra tables"
echo "   ------------------------------------------------------------------------------------------------------------------------------"
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"SELECT COUNT(*) FROM tararam.dt_metric_value;\""
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"SELECT * FROM tararam.md_metric_resource;\""
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"SELECT * FROM tararam.md_resource;\""
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"SELECT * FROM tararam.md_group;\""

echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üöö Load data structure dump into Cassandra tables"
echo "   ------------------------------------------------------------------------------------------------------------------------------"
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"copy tararam.md_metric_resource from '/tmp/tararam.md_metric_resource.csv' with header=true;\""
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"copy tararam.md_resource from '/tmp/tararam.md_resource.csv' with header=true;\""
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"copy tararam.md_group from '/tmp/tararam.md_group.csv' with header=true;\""
echo "  "
echo "  "


for actFile in $(ls -1 ./training-data/$VERSION/$INDEX_TYPE/ | grep "dt_metric_value");
do
    echo "   ------------------------------------------------------------------------------------------------------------------------------"
    echo "   üöö Load data values dump into Cassandra table tararam.dt_metric_value from $actFile"
    echo "   ------------------------------------------------------------------------------------------------------------------------------"
        oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"copy tararam.dt_metric_value from '/tmp/"$actFile"' with header=true;\""
    echo "  "
    echo "  "

done

echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üîé Check Cassandra tables"
echo "   ------------------------------------------------------------------------------------------------------------------------------"
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"SELECT COUNT(*) FROM tararam.dt_metric_value;\""
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"SELECT * FROM tararam.md_metric_resource;\""
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"SELECT * FROM tararam.md_resource;\""
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"SELECT * FROM tararam.md_group;\""


echo "*****************************************************************************************************************************"
echo " ‚úÖ DONE"
echo "*****************************************************************************************************************************"


