#!/bin/bash
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# LOAD EVENTS DIRECTLY INTO CASSANDRA
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ADAPT VALUES
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

echo " ------------------------------------------------------------------------------------------------------------------------------"
echo " üöÄ Starting Load (>=4.1)"
echo " ------------------------------------------------------------------------------------------------------------------------------"
echo "  "
echo "  "

export INDEX_TYPE=events


#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# DO NOT EDIT BELOW
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


if [[  $VERSION == "" ]]; then
    echo "   ------------------------------------------------------------------------------------------------------------------------------"
    echo "   üî¨ Setting Version to default latest"
    echo "   ------------------------------------------------------------------------------------------------------------------------------"
    export VERSION=latest
fi





if [[  $WAIOPS_NAMESPACE == "" ]]; then
    # Get Namespace from Cluster 
    echo "   ------------------------------------------------------------------------------------------------------------------------------"
    echo "   üî¨ Getting Installation Namespace"
    echo "   ------------------------------------------------------------------------------------------------------------------------------"
    export WAIOPS_NAMESPACE=$(oc get po -A|grep aimanager-operator |awk '{print$1}')
    echo "       ‚úÖ OK - AI Manager:               $WAIOPS_NAMESPACE"
fi

if [ ! -x "$(command -v unzip)" ]; then
      echo "‚ùå Unzip not installed."

      echo "‚ùå Aborting...."
      exit 1
fi


echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üîé  Get Cassandra Authentication"	
echo "   ------------------------------------------------------------------------------------------------------------------------------"
export CASSANDRA_PASS=$(oc get secret aiops-topology-cassandra-auth-secret -n $WAIOPS_NAMESPACE -o jsonpath='{.data.password}' | base64 -d)
export CASSANDRA_USER=$(oc get secret aiops-topology-cassandra-auth-secret -n $WAIOPS_NAMESPACE -o jsonpath='{.data.username}' | base64 -d)

echo "CASSANDRA_USER:$CASSANDRA_USER"
echo "CASSANDRA_PASS:$CASSANDRA_PASS"


echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üîé  Check for Training Files in ./training-data/$VERSION/$INDEX_TYPE/"	
echo "   ------------------------------------------------------------------------------------------------------------------------------"
export MERIC_FILES=$(ls -1 ./training-data/$VERSION/$INDEX_TYPE/ | grep "alerts")	
if [[ $MERIC_FILES == "" ]] ;	
then	
      echo "           ‚ùó No Events Dump files found"	
      echo "           ‚ùó    No Events Dump files found to ingest in path ./training-data/$VERSION/$INDEX_TYPE/"	
      echo "           ‚ùó    Please place them in the directory."	
      echo "           ‚ùå Aborting..."	
      exit 1	
else	
      echo "     ‚úÖ Dump Files:                 OK"	
fi	
echo "     "	


#--------------------------------------------------------------------------------------------------------------------------------------------	
#  Check Credentials	
#--------------------------------------------------------------------------------------------------------------------------------------------	

echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üóÑÔ∏è  Indexes to be loaded from ./training-data/$VERSION/$INDEX_TYPE/"	
echo "   ------------------------------------------------------------------------------------------------------------------------------"
ls -1 ./training-data/$VERSION/$INDEX_TYPE/ | grep "aiops"	 | sed 's/^/          /'
echo "       "	
echo "       "	



echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üöÄ Update Training Data"
echo "   ------------------------------------------------------------------------------------------------------------------------------"
export current_date=$(date --date='-1 day' +'%Y-%m-%d')
sed -i "s/2024-02-08/$current_date/g" ./training-data/$VERSION/$INDEX_TYPE/*.csv


echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üíæ Copy Files into Pod"
echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "      üëâ Version    : $VERSION"
echo "  "
echo "  "
    oc rsync -n $WAIOPS_NAMESPACE ./training-data/$VERSION/$INDEX_TYPE/ aiops-topology-cassandra-0:/tmp/
echo "  "
echo "  "


echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üßª Empty Cassandra tables"
echo "   ------------------------------------------------------------------------------------------------------------------------------"
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"TRUNCATE aiops.alerts;\""
echo "  "
echo "  "



echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üîé Check Cassandra tables"
echo "   ------------------------------------------------------------------------------------------------------------------------------"
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"SELECT COUNT(*) FROM aiops.alerts;\""






echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üöö Load data structure dump into Cassandra tables"
echo "   ------------------------------------------------------------------------------------------------------------------------------"
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"copy aiops.alerts from '/tmp/aiops.alerts.csv' with header=true AND MAXBATCHSIZE=100 AND CHUNKSIZE=1;\""
echo "  "
echo "  "


echo "   ------------------------------------------------------------------------------------------------------------------------------"
echo "   üîé Check Cassandra tables"
echo "   ------------------------------------------------------------------------------------------------------------------------------"
    oc exec -ti -n $WAIOPS_NAMESPACE aiops-topology-cassandra-0 -- bash -c "/opt/ibm/cassandra/bin/cqlsh --ssl -u $CASSANDRA_USER -p $CASSANDRA_PASS -e \"SELECT COUNT(*) FROM aiops.alerts;\""


echo "*****************************************************************************************************************************"
echo " ‚úÖ DONE"
echo "*****************************************************************************************************************************"


